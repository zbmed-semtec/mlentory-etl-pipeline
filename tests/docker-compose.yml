version: "3.8" 

services:
  test:
    depends_on:
        - mysql
    profiles:
      - test
    build: 
      context: .
      dockerfile: ./Dockerfile  # Path to tests Dockerfile
    # Define volumes to mount extractor scripts or dependencies
    volumes:
      - .:/app_test/tests
      - ../code/transform:/app_test/transform
      - ../code/extractors:/app_test/extractors
      - ../code/load:/app_test/load
      - ../data/transform_queue:/app_test/transform_queue
      - ../data/load_queue:/app_test/load_queue
      - ../code/config_data:/app_test/config_data
    dns:
      - 1.1.1.1

    # Uncomment this line to test the script
    command: ["tail", "-f", "/dev/null"]


  ci_test:
    depends_on:
      - mysql
    profiles:
      - ci_test
    build: 
      context: .
      dockerfile: ./Dockerfile  # Path to test Dockerfile
    # Define volumes to mount extractor scripts or dependencies
    volumes:
      - .:/app_test/tests
      - ../code/transform:/app_test/transform
      - ../code/extractors:/app_test/extractors
      - ../code/load:/app_test/load
      - ../data/transform_queue:/app_test/transform_queue
      - ../data/load_queue:/app_test/load_queue
      - ../code/config_data:/app_test/config_data
    dns:
      - 1.1.1.1
    # command: ["./tests/validate_tests.sh"]
    command: ["/bin/bash"]
    # command:
    #   - /bin/sh 
    #   - -c
    #   - |
    #     ls
    #     ./tests/wait-for-it.sh mysql:3306 --
    #     pytest
     
    # command: ["tail", "-f", "/dev/null"]

  mysql:
    profiles:
      - ci_test
      - test
    image: mysql:latest
    hostname: mysql
    environment:
      MYSQL_ROOT_PASSWORD: test_pass
      MYSQL_DATABASE: test_db
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_pass
    ports:
      - "3306:3306"
      - "33060:33060"
    # command: --init-file /docker-entrypoint-initdb.d/init.sql

 
# networks:
#   my-macvlan-net:
#     external: true
#     name: my-macvlan-net
#   host:
#     external: true

